<!DOCTYPE html>
<html lang="vi" class="h-full">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Document</title>
    <script src="../../js/const.js"></script>
    <script src="../../lib/moment.min.js"></script>
    <script src="../../lib/socket.io.min.js"></script>
    <script src="../../lib/tailwindcss.js"></script>
</head>

<body class="h-full bg-gray-900 text-gray-100">
    <div class="min-h-screen flex flex-col">
        <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
            <h1 class="text-2xl font-bold text-white mb-2">Socket.IO Document</h1>
            <p class="text-sm text-gray-400 mt-1">
                Namespace: <code id="currentNamespace" class="bg-gray-700 px-2 py-1 rounded">Đang tải...</code>
            </p>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row gap-4 p-4">
            <!-- Menu Namespaces -->
            <div class="lg:w-60 bg-gray-800 rounded-xl shadow-xl p-4 space-y-4" style="max-height: 85vh;">
                <h3 class="text-lg font-semibold text-white">Namespaces</h3>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="window.location.href='?type=userHomes'"
                        class="flex-1 text-sm text-center py-2 px-4 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition disabled:bg-gray-600 disabled:text-neutral-800 disabled:cursor-not-allowed">
                        /socket/userHomes
                    </button>

                    <button disabled onclick="window.location.href='?type=mainUserHome'"
                        class="flex-1 text-sm text-center py-2 px-4 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition disabled:bg-gray-600 disabled:text-neutral-800 disabled:cursor-not-allowed">
                        /socket/mainUserHome
                    </button>
                </div>
            </div>

            <!-- Control Panel -->
            <div id="controlPanel" class="lg:w-1/3 bg-gray-800 rounded-xl shadow-xl p-5 space-y-5 overflow-y-auto"
                style="max-height: 85vh;">
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-white">Payload Editor (JSON)</h3>
                        <button onclick="formatJson()"
                            class="text-xs bg-cyan-600 hover:bg-cyan-700 px-3 py-1 rounded transition">
                            Format
                        </button>
                    </div>

                    <textarea id="jsonPayload"
                        class="w-full h-64 bg-gray-900 text-gray-100 font-mono text-sm rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none"
                        placeholder="Nhập payload JSON ở đây..."></textarea>


                </div>

                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2">
                        <span class="bg-orange-500 text-white text-xs font-semibold p-2 rounded-full">
                            emit
                        </span>
                        <button onclick="joinRoom()"
                            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium p-2 rounded-lg transition flex items-center justify-center gap-2">
                            <span id="joinEventName">-</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-orange-500 text-white text-xs font-semibold p-2 rounded-full">
                            emit
                        </span>
                        <button onclick="leaveRoom()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-medium p-2 rounded-lg transition flex items-center justify-center gap-2">
                            <span id="leaveEventName">-</span>
                        </button>
                    </div>

                </div>

                <div class="text-sm text-gray-400 space-y-1 bg-gray-900/50 p-4 rounded-lg font-mono">
                    <p>Interval: <span class="font-semibold text-white-400">5 seconds</span></p>
                    <p>Status: <span id="status" class="font-semibold text-orange-400">Disconnected</span></p>
                    <p>clientId: <span id="clientId" class="font-bold text-white">-</span></p>
                    <p>Room: <span id="room" class="font-bold text-white">-</span></p>
                </div>

                <button onclick="clearLog()"
                    class="w-full py-2 text-sm bg-neutral-600 hover:bg-neutral-700 rounded transition">
                    Clear log
                </button>
            </div>

            <!-- Log Panel -->
            <div class="flex-1 bg-gray-800 rounded-xl shadow-xl p-5 overflow-hidden flex flex-col"
                style="max-height: 85vh;">
                <h2 class="text-xl font-semibold mb-4 flex items-center justify-between">
                    <span>Event Logs</span>
                    <span id="counter" class="text-sm text-gray-500">0 messages</span>
                </h2>
                <div id="log" class="flex-1 overflow-y-auto font-mono text-xs space-y-2 pr-2"></div>
            </div>
        </div>
    </div>

    <script>
        // Đọc type từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type') || 'userHomes';

        // Cấu hình chi tiết từng namespace
        const config = {
            userHomes: {
                namespace: '/socket/userHomes',
                roomPrefix: 'user-',
                roomKey: "userCode",
                joinEvent: 'joinUserHomesRoom',
                leaveEvent: 'leaveUserHomesRoom',
                streamEvent: 'streamUserHomesSensorData',
                defaultPayload: {
                    userCode: "USR000001",
                    userHomeCodes: ["HOM000001", "HOM000002"]
                }
            },
            mainUserHome: {
                namespace: '/socket/mainUserHome',
                roomPrefix: 'user-home-',
                roomKey: "userCode",
                joinEvent: 'joinMainUserHomeRoom',
                leaveEvent: 'leaveMainUserHomeRoom',
                streamEvent: 'streamMainUserHomeData',
                defaultPayload: {
                    userCode: "USR000001",
                    userHomeCode: "HOM000001"
                }
            }
        };

        const cfg = config[type] || config.userHomes;

        // TỰ ĐỘNG ĐIỀN JSON DEFAULT 
        const defaultJsonString = JSON.stringify(cfg.defaultPayload, null, 4);

        document.getElementById('currentNamespace').textContent = cfg.namespace;
        document.getElementById('joinEventName').textContent = cfg.joinEvent;
        document.getElementById('leaveEventName').textContent = cfg.leaveEvent;
        document.getElementById('jsonPayload').value = defaultJsonString;

        // Kết nối Socket.IO
        const socket = io(`${CURRENT_URL}${cfg.namespace}`, { transports: ['websocket'] });

        const $ = id => document.getElementById(id);
        let count = 0;
        const logEl = $('log');
        const counter = $('counter');
        const status = $('status');
        const clientIdEl = $('clientId');
        const roomEl = $('room');

        const addLog = (type, title, data) => {
            count++;
            counter.textContent = `${count} messages`;
            const time = moment().format('HH:mm:ss');
            const line = document.createElement('div');
            line.className = `p-3 rounded-lg bg-gray-700/50 border-l-4 ${type === 'success' ? 'border-green-500' :
                type === 'info' ? 'border-blue-500' :
                    type === 'warn' ? 'border-yellow-500' : 'border-red-500'
                }`;

            const badge = type === 'info' ? `<span class="bg-orange-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full ml-2 mr-2">on</span>` : '';
            const titleColor = type === 'success' ? 'text-green-400' :
                type === 'info' ? 'text-blue-400' :
                    type === 'warn' ? 'text-yellow-400' : 'text-red-400';

            line.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="flex items-center font-semibold ${titleColor}">
                        [${time}] ${badge} '${title}'
                    </span>
                </div>
                <pre class="json overflow-x-auto text-xs whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
            `;
            logEl.prepend(line);
        };

        socket.on('connect', () => {
            status.textContent = 'Connected';
            status.className = 'font-semibold text-green-400';
            clientIdEl.textContent = socket.id;
            addLog('success', 'Connected', { clientId: socket.id });
        });

        socket.on('disconnect', () => {
            status.textContent = 'Disconnected';
            status.className = 'font-semibold text-red-400';
            addLog('error', 'Disconnected', {});
        });

        socket.on(cfg.streamEvent, payload => addLog('info', cfg.streamEvent, payload));
        socket.on('roomJoined', d => addLog('success', 'roomJoined', d));
        socket.on('roomLeft', d => addLog('warn', 'roomLeft', d));
        socket.on('error', err => addLog('error', 'Server Error', err));

        function getPayload() {
            try {
                const raw = $('jsonPayload').value.trim();
                if (!raw) throw new Error('Payload trống!');
                return JSON.parse(raw); // Giữ nguyên kiểu: array, object, string...
            } catch (e) {
                alert('JSON không hợp lệ!\n' + e.message);
                return null;
            }
        }

        window.formatJson = () => {
            try {
                const obj = JSON.parse($('jsonPayload').value);
                $('jsonPayload').value = JSON.stringify(obj, null, 4);
            } catch (e) {
                alert('Không thể format: JSON lỗi!');
            }
        };

        window.resetToDefault = () => {
            if (confirm('Khôi phục về payload mặc định?')) {
                $('jsonPayload').value = defaultJsonString;
                formatJson();
            }
        };

        window.joinRoom = () => {
            const payload = getPayload();
            if (!payload) return;

            socket.emit(cfg.joinEvent, payload);
            // Lấy key đầu tiên để hiển thị room -> room name đồng nhất phía backend
            roomEl.textContent = `${cfg.roomPrefix}${cfg.defaultPayload[cfg.roomKey]}-room`;

            addLog('warn', cfg.joinEvent, payload);
        };

        window.leaveRoom = () => {
            const payload = getPayload();
            if (!payload) return;

            console.log(payload);
            socket.emit(cfg.leaveEvent, { [cfg.roomKey]: payload[cfg.roomKey] });
            roomEl.textContent = '-';
            addLog('warn', cfg.leaveEvent, { [cfg.roomKey]: payload[cfg.roomKey] });
        };

        window.clearLog = () => {
            leaveRoom();
            logEl.innerHTML = '';
            count = 0;
            counter.textContent = '0 messages';
        };

        // Auto format khi rời textarea
        $('jsonPayload').addEventListener('blur', formatJson);
    </script>
</body>

</html>